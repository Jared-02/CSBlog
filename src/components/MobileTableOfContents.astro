---
interface Heading {
	depth: number;
	slug: string;
	text: string;
}

interface Props {
	headings: Heading[];
}

const { headings } = Astro.props;
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{tocHeadings.length > 0 && (
	<mobile-toc class="mobile-toc">
		<details>
			<summary>
				<span class="mobile-toc-label">
					<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
					<span class="mobile-toc-title">On this page</span>
				</span>
				<svg class="caret" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
			</summary>
			<nav class="mobile-toc-content">
				<ul>
					{tocHeadings.map((heading) => (
						<li class:list={[`depth-${heading.depth}`]}>
							<a href={`#${heading.slug}`}>{heading.text}</a>
						</li>
					))}
				</ul>
			</nav>
		</details>
	</mobile-toc>
)}

<style>
	.mobile-toc {
		display: none;
	}
	@media (max-width: 1024px) {
		.mobile-toc {
			display: block;
			position: sticky;
			top: 0;
			z-index: 10;
			background: white;
			border-bottom: 1px solid rgb(var(--gray-light));
		}
	}
	details {
		margin: 0;
	}
	summary {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 0.6rem 1rem;
		cursor: pointer;
		font-size: 0.85rem;
		font-weight: 500;
		color: rgb(var(--gray-dark));
		list-style: none;
		user-select: none;
	}
	summary::-webkit-details-marker {
		display: none;
	}
	summary::marker {
		content: '';
	}
	.mobile-toc-label {
		display: flex;
		align-items: center;
		gap: 0.4rem;
	}
	.caret {
		transition: transform 0.2s;
	}
	details[open] .caret {
		transform: rotate(180deg);
	}
	.mobile-toc-content {
		max-height: 60vh;
		overflow-y: auto;
		padding: 0 1rem 0.75rem;
		border-top: 1px solid rgb(var(--gray-light));
	}
	ul {
		list-style: none;
		padding: 0;
		margin: 0;
	}
	li {
		margin-bottom: 0.1rem;
	}
	li.depth-3 {
		padding-left: 1rem;
	}
	a {
		display: block;
		padding: 0.35rem 0.5rem;
		color: rgb(var(--gray));
		text-decoration: none;
		font-size: 0.85rem;
		border-radius: 4px;
		transition: color 0.15s, background 0.15s;
	}
	a:hover {
		color: rgb(var(--gray-dark));
		background: rgba(var(--gray-light), 0.5);
	}
</style>

<script>
	class MobileToc extends HTMLElement {
		constructor() {
			super();
			const details = this.querySelector('details');
			if (!details) return;

			// Close on link click
			this.querySelectorAll('a').forEach((link) => {
				link.addEventListener('click', () => {
					details.removeAttribute('open');
				});
			});

			// Close on outside click
			document.addEventListener('click', (e) => {
				if (!this.contains(e.target as Node)) {
					details.removeAttribute('open');
				}
			});

			// Close on Escape
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && details.open) {
					details.removeAttribute('open');
					const summary = details.querySelector('summary');
					summary?.focus();
				}
			});
		}
	}

	customElements.define('mobile-toc', MobileToc);
</script>

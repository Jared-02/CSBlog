---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import LeftSidebar from '../components/LeftSidebar.astro';
import MobileTableOfContents from '../components/MobileTableOfContents.astro';
import Search from '../components/Search.astro';
import TableOfContents from '../components/TableOfContents.astro';

interface Props {
	data: CollectionEntry<'blog'>['data'];
	headings: { depth: number; slug: string; text: string }[];
	allPosts: CollectionEntry<'blog'>[];
	currentPostId: string;
}

const { data, headings, allPosts, currentPostId } = Astro.props;
const { title, description, pubDate, updatedDate, heroImage } = data;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			.page-layout {
				display: grid;
				grid-template-columns: 200px 1fr 200px;
				gap: 2rem;
				max-width: 1200px;
				margin: 0 auto;
				padding: 2rem 1.5rem;
			}
			.content-area {
				min-width: 0;
			}
			.hero-image {
				width: 100%;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: var(--box-shadow);
			}
			.prose {
				max-width: 100%;
				padding: 0;
				color: rgb(var(--gray-dark));
			}
			.title {
				margin-bottom: 1em;
				padding: 1em 0;
				line-height: 1;
			}
			.title h1 {
				margin: 0 0 0.5em 0;
				font-size: 2rem;
			}
			.date {
				margin-bottom: 0.5em;
				color: rgb(var(--gray));
				font-size: 0.9rem;
			}
			.last-updated-on {
				font-style: italic;
			}
			@media (max-width: 1024px) {
				.page-layout {
					grid-template-columns: 1fr;
					padding: 1rem;
				}
				.left-sidebar-wrapper,
				.right-sidebar-wrapper {
					display: none;
				}
			}
			@media (max-width: 768px) {
				.page-layout {
					padding: 0.75rem;
					gap: 1rem;
				}
				.title h1 {
					font-size: 1.5rem;
				}
				.title {
					padding: 0.5em 0;
				}
			}
		</style>
	</head>

	<body>
		<Header />
		<MobileTableOfContents headings={headings} />
		<main>
			<div class="page-layout">
				<div class="left-sidebar-wrapper">
					<LeftSidebar allPosts={allPosts} currentPostId={currentPostId} />
				</div>
				<div class="content-area">
					<article data-pagefind-body>
						<div class="hero-image">
							{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
						</div>
						<div class="prose">
							<div class="title">
								<div class="date">
									<FormattedDate date={pubDate} />
									{
										updatedDate && (
											<div class="last-updated-on">
												Last updated on <FormattedDate date={updatedDate} />
											</div>
										)
									}
								</div>
								<h1>{title}</h1>
								<hr />
							</div>
							<slot />
						</div>
					</article>
				</div>
				<div class="right-sidebar-wrapper">
					<TableOfContents headings={headings} />
				</div>
			</div>
		</main>
		<Footer />
		<Search />
		<script>
			const langMap: Record<string, string> = {
				py: 'Python', python: 'Python',
				js: 'JavaScript', javascript: 'JavaScript',
				ts: 'TypeScript', typescript: 'TypeScript',
				jsx: 'JSX', tsx: 'TSX',
				html: 'HTML', css: 'CSS', scss: 'SCSS',
				json: 'JSON', yaml: 'YAML', yml: 'YAML',
				md: 'Markdown', mdx: 'MDX',
				sh: 'Shell', bash: 'Bash', zsh: 'Zsh',
				c: 'C', cpp: 'C++', 'c++': 'C++',
				java: 'Java', go: 'Go', rust: 'Rust', rs: 'Rust',
				rb: 'Ruby', ruby: 'Ruby', php: 'PHP',
				sql: 'SQL', graphql: 'GraphQL',
				xml: 'XML', svg: 'SVG',
				plaintext: '', text: '',
			};

			const copyIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
			const checkIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';

			function createCopyButton(pre: Element) {
				const btn = document.createElement('button');
				btn.className = 'copy-btn';
				btn.setAttribute('aria-label', 'Copy code');
				btn.innerHTML = copyIcon;
				btn.addEventListener('click', () => {
					const code = pre.querySelector('code');
					if (code) {
						navigator.clipboard.writeText(code.textContent || '');
						btn.classList.add('copied');
						btn.innerHTML = checkIcon;
						setTimeout(() => {
							btn.classList.remove('copied');
							btn.innerHTML = copyIcon;
						}, 2000);
					}
				});
				return btn;
			}

			// Standalone code blocks (not inside .code-group)
			document.querySelectorAll('pre').forEach((pre) => {
				if (pre.closest('.code-group')) return;

				const rawLang = pre.getAttribute('data-language') || '';
				const lang = langMap[rawLang] ?? rawLang;

				const wrapper = document.createElement('div');
				wrapper.className = 'code-block';
				pre.parentNode!.insertBefore(wrapper, pre);

				const bar = document.createElement('div');
				bar.className = 'code-bar';

				const label = document.createElement('span');
				label.className = 'code-lang';
				label.textContent = lang;
				bar.appendChild(label);

				bar.appendChild(createCopyButton(pre));

				wrapper.appendChild(bar);
				wrapper.appendChild(pre);
			});

			// Tabbed code groups
			document.querySelectorAll('.code-group').forEach((group) => {
				const tabs = group.querySelectorAll('.code-tab');
				const panels = group.querySelectorAll('.code-tab-panel');

				// Add copy button to each panel
				panels.forEach((panel) => {
					const pre = panel.querySelector('pre');
					if (pre) {
						const btnWrap = document.createElement('div');
						btnWrap.className = 'code-tab-copy';
						btnWrap.appendChild(createCopyButton(pre));
						panel.appendChild(btnWrap);
					}
				});

				tabs.forEach((tab) => {
					tab.addEventListener('click', () => {
						const index = (tab as HTMLElement).dataset.tabIndex;
						tabs.forEach((t) => t.classList.remove('active'));
						panels.forEach((p) => p.classList.remove('active'));
						tab.classList.add('active');
						const target = group.querySelector(`.code-tab-panel[data-panel-index="${index}"]`);
						target?.classList.add('active');
					});
				});
			});
		</script>
	</body>
</html>
